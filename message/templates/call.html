{% extends "base.html" %}

{% block title %}ELearning - Call{% endblock %}

{% block content %}
<!-- Header -->
<div class="p-4 border-b border-gray-200 flex items-center justify-between">
    <div class="flex items-center space-x-3">
        {% if target.userprofile.picture %}
        <img src="{{ target.userprofile.picture.url }}" alt="Profile picture"
            class="w-20 h-20 rounded-full object-cover">
        {% else %}
        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
            {{ target.username|first|upper }}
        </div>
        {% endif %}
        <div>
            <h3 class="font-semibold text-gray-900">{{ target.userprofile.name }}</h3>
            <p class="text-sm text-gray-500 call-status">Calling...</p>
        </div>
    </div>
</div>

<div class="relative bg-gray-100 w-full" style="aspect-ratio: 16/9;">

    <!-- p5.js canvas -->
    <div id="canvas-container" class="w-full h-full"></div>

    <!-- Calling Overlay -->
    <div id="calling-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-100">
        <div class="w-24 h-24 rounded-full overflow-hidden mb-4 ring-4 ring-blue-100">
            {% if target.userprofile.picture %}
            <img src="{{ target.userprofile.picture.url }}" class="w-full h-full object-cover">
            {% else %}
            <div class="w-full h-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-3xl font-bold">
                {{ target.username|first|upper }}
            </div>
            {% endif %}
        </div>
        <p class="text-gray-900 text-xl font-semibold mb-1">{{ target.userprofile.name }}</p>
        <p class="text-gray-400 text-sm animate-pulse call-status">Calling...</p>
    </div>

</div>

<!-- Controls -->
<div class="p-4 border-t border-gray-200 flex items-center justify-center gap-4">
    <button onclick="clearBoard()"
        class="w-12 h-12 bg-gray-200 hover:bg-gray-300 rounded-full flex items-center justify-center transition-colors" title="Clear board">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
    </button>
    <button onclick="hangUp()"
        class="w-12 h-12 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white rotate-135" fill="currentColor" viewBox="0 0 24 24">
            <path d="M6.6 10.8c1.4 2.8 3.8 5.1 6.6 6.6l2.2-2.2c.3-.3.7-.4 1-.2 1.1.4 2.3.6 3.6.6.6 0 1 .4 1 1V20c0 .6-.4 1-1 1C10.6 21 3 13.4 3 4c0-.6.4-1 1-1h3.5c.6 0 1 .4 1 1 0 1.3.2 2.5.6 3.6.1.3 0 .7-.2 1L6.6 10.8z"/>
        </svg>
    </button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
<script>
    const ws = new WebSocket(`ws://${window.location.host}/ws/call/{{ conversation.id }}/`);
    const rtc = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });

    const callingOverlay = document.getElementById('calling-overlay');
    const callStatus = document.querySelectorAll('.call-status');

    const localStrokes = [];
    let currentStroke = [];
    const remoteStrokes = [];
    let remoteCurrentStroke = [];
    let lastSentAt = 0;

    new p5((sketch) => {
        sketch.setup = () => {
            const container = document.getElementById('canvas-container');
            const canvas = sketch.createCanvas(container.offsetWidth, container.offsetHeight);
            canvas.parent('canvas-container');
        };

        sketch.draw = () => {
            sketch.background(243, 244, 246);

            sketch.stroke(50);
            sketch.strokeWeight(2);
            sketch.noFill();
            [...localStrokes, currentStroke].forEach(stroke => {
                sketch.beginShape();
                stroke.forEach(p => sketch.vertex(p.x * sketch.width, p.y * sketch.height));
                sketch.endShape();
            });

            sketch.stroke(59, 130, 246);
            [...remoteStrokes, remoteCurrentStroke].forEach(stroke => {
                sketch.beginShape();
                stroke.forEach(p => sketch.vertex(p.x * sketch.width, p.y * sketch.height));
                sketch.endShape();
            });
        };

        sketch.mousePressed = () => {
            if (sketch.mouseX < 0 || sketch.mouseX > sketch.width ||
                sketch.mouseY < 0 || sketch.mouseY > sketch.height) return;
            currentStroke = [];
        };

        sketch.mouseDragged = () => {
            if (sketch.mouseX < 0 || sketch.mouseX > sketch.width ||
                sketch.mouseY < 0 || sketch.mouseY > sketch.height) return;
            const pt = { x: sketch.mouseX / sketch.width, y: sketch.mouseY / sketch.height };
            currentStroke.push(pt);

            const now = performance.now();
            if (now - lastSentAt > 16) {
                ws.send(JSON.stringify({ type: 'draw_point', x: pt.x, y: pt.y }));
                lastSentAt = now;
            }
        };

        sketch.mouseReleased = () => {
            if (currentStroke.length > 0) {
                localStrokes.push([...currentStroke]);
                currentStroke = [];
                ws.send(JSON.stringify({ type: 'draw_end' }));
            }
        };
    });

    ws.onmessage = async (e) => {
        const data = JSON.parse(e.data);

        if (data.type === 'ping') {
            callStatus.forEach(el => el.textContent = 'Connecting...');
            ws.send(JSON.stringify({ type: 'pong' }));
        }

        if (data.type === 'pong') {
            callStatus.forEach(el => el.textContent = 'Connecting...');
        }

        if (data.type === 'call_offer') {
            await rtc.setRemoteDescription(new RTCSessionDescription(data.offer));

            const answer = await rtc.createAnswer();
            await rtc.setLocalDescription(answer);

            await waitForIce();

            ws.send(JSON.stringify({ type: 'call_answer', answer: rtc.localDescription }));
            
        }

        if (data.type === 'call_answer') {
            await rtc.setRemoteDescription(new RTCSessionDescription(data.answer));
        }

        if (data.type === 'call_ended') {

        }

        if (data.type === 'draw_point') {
            remoteCurrentStroke.push({ x: data.x, y: data.y });
        }

        if (data.type === 'draw_end') {
            if (remoteCurrentStroke.length > 0) {
                remoteStrokes.push([...remoteCurrentStroke]);
                remoteCurrentStroke = [];
            }
        }

        if (data.type === 'draw_clear') {
            remoteStrokes.length = 0;
            remoteCurrentStroke = [];
        }
    };

    rtc.onconnectionstatechange = () => {
        if (rtc.connectionState === 'connected') {
            callingOverlay.classList.add('hidden');
            callStatus.forEach(el => el.textContent = 'Connected');
        }
    };

    ws.onopen = () => {
        ws.send(JSON.stringify({ type: 'ping' }));
    };

    window.onload = async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });
        stream.getTracks().forEach(track => rtc.addTrack(track, stream));

        const offer = await rtc.createOffer();
        await rtc.setLocalDescription(offer);

        await waitForIce();

        ws.send(JSON.stringify({ type: 'call_offer', offer: rtc.localDescription }));
    }

    function hangUp() {
        ws.send(JSON.stringify({ type: 'hang_up' }));
        window.location = "{% url 'threads' %}";
    }

    function clearBoard() {
        localStrokes.length = 0;
        currentStroke = [];
        ws.send(JSON.stringify({ type: 'draw_clear' }));
    }

    function waitForIce() {
        return new Promise(resolve => {
            rtc.onicecandidate = (e) => {
                if (!e.candidate) resolve();
            };
        });
    }
</script>
{% endblock %}