{% extends "shared/base.html" %}

{% block title %}{{ course.title }} - ELearning{% endblock %}

{% block chat_content %}
<!-- Chat Header -->
<div class="p-4 border-b border-gray-200 flex items-center justify-between">
    <div class="flex items-center space-x-3">
        {% if target.userprofile.picture %}
        <img src="{{ target.userprofile.picture.url }}" alt="Profile picture"
            class="w-20 h-20 rounded-full object-cover">
        {% else %}
        <div
            class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
            {{ target.username|first|upper }}
        </div>
        {% endif %}
        <div>
            <h3 class="font-semibold text-gray-900">{{ target.userprofile.name }}</h3>
            <p class="text-sm text-gray-500"></p>
        </div>
    </div>
    <a href="{% url 'profile' id=target.id %}" class="text-blue-600 hover:text-blue-700 font-medium text-sm">View
        Profile</a>
</div>

<!-- Messages Area -->
<div id="messages" class="flex-1 overflow-y-auto p-6 space-y-4">
    {% for m in messages %}
    {% if m.sender == request.user %}
    <!-- Sent Message -->
    <div class="flex items-start space-x-3 justify-end">
        <div class="flex-1 flex flex-col items-end">
            <div class="bg-blue-600 rounded-lg p-3 max-w-md">
                <p class="text-white">{{ m.content }}</p>
            </div>
            <span class="text-xs text-gray-500 mt-1 block">{{ m.sent_at|date:"N j, g:i A" }}</span>
        </div>
    </div>
    {% else %}
    <!-- Received Message -->
    <div class="flex items-start space-x-3">
        <div class="flex-1">
            <div class="bg-gray-100 rounded-lg p-3 max-w-md">
                <p class="text-gray-800">{{ m.content }}</p>
            </div>
            <span class="text-xs text-gray-500 mt-1 block">{{ m.sent_at|date:"N j, g:i A" }}</span>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

<!-- Message Input Area -->
<div class="p-4 border-t border-gray-200">
    <div class="flex items-end space-x-3">
        <textarea id="message-input" rows="1" placeholder="Type a message..."
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
        <button id="message-submit" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
        </button>
    </div>
</div>

<script>
    const currentUserId = {{ user.id }};
    const ws = new WebSocket(`ws://${window.location.host}/ws/messages/{{ conversation.id }}/`);

    const textarea = document.getElementById('message-input');
    const sendBtn = document.getElementById('message-submit');
    const msgContainer = document.getElementById('messages');

    ws.onopen = () => console.log('Connected');

    ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        const isSent = data.sender_id == currentUserId;

        const div = document.createElement('div');
        div.className = `flex items-start space-x-3 ${isSent ? 'justify-end' : ''}`;
        div.innerHTML = isSent
            ? `<div class="flex-1 flex flex-col items-end">
                <div class="bg-blue-600 rounded-lg p-3 max-w-md">
                    <p class="text-white">${data.message}</p>
                </div>
                <span class="text-xs text-gray-500 mt-1 block">${data.sent_at}</span>
            </div>`
            : `<div class="flex-1">
                <div class="bg-gray-100 rounded-lg p-3 max-w-md">
                    <p class="text-gray-800">${data.message}</p>
                </div>
                <span class="text-xs text-gray-500 mt-1 block">${data.sent_at}</span>
            </div>`;

        msgContainer.appendChild(div);
        msgContainer.scrollTop = msgContainer.scrollHeight;
    };


    ws.onclose = () => console.log('Disconnected');
    ws.onerror = (e) => console.error('WS error', e);

    sendBtn.addEventListener('click', () => {
        const msg = textarea.value.trim();
        if (!msg) return;
        ws.send(JSON.stringify({ message: msg }));
        textarea.value = '';
    });

    textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendBtn.click();
        }
    });
</script>
{% endblock %}