{% extends "base.html" %}
{% load role_check %}
{% load humanize %}
{% load progress_percentage %}
{% load notification %}

{% block title %}{{ course.title }} - ELearning{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">My Dashboard</h1>

    <div class="grid grid-cols-3 gap-6">
        <!-- Status -->
        <div class="col-span-2 space-y-6">
            <!-- Create Status -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center space-x-3">
                    <div
                        class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
                        {{ user.username|first|upper }}
                    </div>
                    <a href="{% url 'status' %}"
                        class="flex-1 text-left px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-500 transition">
                        What's on your mind?
                    </a>
                </div>
                <div class="mt-4 pt-4 border-t">
                    <a href="{% url 'status' %}" class="block w-full text-center bg-blue-600 hover:bg-blue-700 
                text-white font-medium py-2 px-4 rounded-lg transition">
                        Create Status
                    </a>
                </div>
            </div>

            {% for s in page %}
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center space-x-3 mb-4">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white text-sm font-bold">
                        {{ user.username|first|upper }}
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900">{{ user.username }}</h3>
                        <p class="text-sm text-gray-500">{{ s.created_at|timesince }} ago</p>
                    </div>
                </div>
                <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">
                    {{s.text}}
                </p>
                {% if s.image %}
                <img src={{ s.image.url }} alt="Status pic" class="w-full rounded-lg">
                {% endif %}
            </div>
            {% empty %}
            <p>No status updates yet.</p>
            {% endfor %}


            <!-- Pagination -->
            <div class="flex justify-center space-x-2 mt-6">
                {% if page_obj.has_previous %}
                <a href="?page={{ page.previous_page_number }}"
                    class="px-4 py-2 bg-white border rounded-lg text-gray-700 hover:bg-gray-50">
                    Previous
                </a>
                {% endif %}

                {% for num in page.paginator.page_range %}
                {% if page.number == num %}
                <span class="px-4 py-2 bg-blue-600 text-white rounded-lg">
                    {{ num }}
                </span>
                {% else %}
                <a href="?page={{ num }}" class="px-4 py-2 bg-white border rounded-lg text-gray-700 hover:bg-gray-50">
                    {{ num }}
                </a>
                {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <a href="?page={{ page.next_page_number }}"
                    class="px-4 py-2 bg-white border rounded-lg text-gray-700 hover:bg-gray-50">
                    Next
                </a>
                {% endif %}
            </div>
        </div>

        <div class="space-y-6">
            <!-- Course Progress -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900">My Courses</h2>
                    {% if user|is_teacher %}
                    <a href="/course/new" class="text-sm font-medium text-blue-600 hover:text-blue-700">
                        + New Course
                    </a>
                    {% endif %}
                </div>
                <div class="space-y-4">
                    {% for c in courses %}
                    <a href="{% url 'course' id=c.id %}" class="block hover:bg-gray-50 rounded-lg transition p-3 -m-3">
                        <div class="flex items-center space-x-4 mb-3">
                            <img src="{% if c.cover_img and c.cover_img.name %}{{ c.cover_img.url }}{% else %}https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=100{% endif %}"
                                alt="Course" class="w-16 h-16 object-cover rounded flex-shrink-0">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 text-sm mb-1">{{c.title}}</h3>
                                <div class="flex items-center space-x-3 text-xs text-gray-600">
                                    <span class="flex items-center">
                                        <svg class="w-3 h-3 text-yellow-400 fill-current mr-1" viewBox="0 0 20 20">
                                            <path
                                                d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" />
                                        </svg>
                                        {{ c.avg_rating }}
                                    </span>
                                    <span>{{ c.enrollments.count|intcomma }} students</span>
                                </div>
                            </div>
                        </div>
                        {% if user|is_student %}
                        {% with progress=c|progress_percentage:user %}
                        <div class="space-y-1">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Progress</span>
                                <span class="font-semibold text-blue-600">{{ progress }}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: {{ progress }}%"></div>
                            </div>
                        </div>
                        {% endwith %}
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
            </div>

            <!-- Notifications and Deadlines Tabs -->
            <div class="bg-white rounded-lg shadow-sm">
                <div class="flex border-b">
                    <button class="flex-1 px-6 py-4 text-sm font-semibold text-blue-600 border-b-2 border-blue-600"
                        onclick="showTab('notifications')">
                        Notifications
                    </button>
                    {% if user|is_student %}
                    <button class="flex-1 px-6 py-4 text-sm font-semibold text-gray-600 hover:text-gray-900"
                        onclick="showTab('deadlines')">
                        Upcoming Deadlines
                    </button>
                    {% endif %}
                </div>

                <!-- Notifications -->
                <div id="notifications-tab" class="p-6">
                    <div class="space-y-4">
                        {% for noti in notifications %}
                        <a href="{{ noti.redirect_url }}">
                            <div class="flex items-start space-x-3 p-3 hover:bg-gray-50 rounded-lg transition">
                                {% notification_icon noti.notification_type %}
                                <div class="flex-1">
                                    <p class="text-sm text-gray-900">{{ noti.content }}</p>
                                    <p class="text-xs text-gray-500 mt-1">{{ noti.created_at|timesince }} ago</p>
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Deadlines -->
                <div id="deadlines-tab" class="p-6 hidden">
                    <div class="space-y-4">
                        {% for deadline in deadlines %}
                        {% with urgency=deadline.due_date|deadline_urgency %}
                        <a href="{% url 'material' cid=deadline.module.course.id mid=deadline.id %}">
                            <div class="flex items-start space-x-3 p-3 hover:bg-gray-50 rounded-lg transition border-l-4 border-{{ urgency }}-500">
                                <div class="w-10 h-10 bg-{{ urgency }}-100 rounded-full flex items-center justify-center flex-shrink-0">
                                    <svg class="w-5 h-5 text-{{ urgency }}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-gray-900">{{ deadline.name }}</p>
                                    <p class="text-sm text-gray-600">{{ deadline.module.course.title }}</p>
                                    <p class="text-xs text-{{ urgency }}-600 font-semibold mt-1">Due {{ deadline.due_date|naturalday }} ({{ deadline.due_date|timeuntil }})</p>
                                </div>
                            </div>
                        </a>
                        {% endwith %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function showTab(tabName) {
        document.getElementById('notifications-tab').classList.add('hidden');
        document.getElementById('deadlines-tab').classList.add('hidden');

        const buttons = document.querySelectorAll('button[onclick^="showTab"]');
        buttons.forEach(button => {
            button.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            button.classList.add('text-gray-600');
        });

        document.getElementById(tabName + '-tab').classList.remove('hidden');

        event.target.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        event.target.classList.remove('text-gray-600');
    }
</script>

{% endblock %}